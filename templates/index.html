<!DOCTYPE html>

<html lang="nl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>arch.be location search</title>
		<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<script>

		var workerid = 0;

		  function toon_kaart() {
			console.log("getting map for worker id "+ workerid)
			  $.ajax({
		   url:"/get_map?workerid="+workerid,
		   method:"GET",
		   beforeSend:function()
		   {
			$('#save').attr('disabled', 'disabled');
			$('#process').css('display', 'block');
		   },
		   success:function(data)
		   {
			  console.log(data)
			  document.getElementById("kaart").innerHTML = data ;
		   }
		  })
		  };


		 $(document).ready(function(){

		// Find all inputs on the DOM which are bound to a datalist via their list attribute.
		var inputs = document.querySelectorAll('input[list]');
		for (var i = 0; i < inputs.length; i++) {
			// When the value of the input changes...

			inputs[i].addEventListener('pointerdown', function() {
			  console.log("click " + this.id);
			  this.value = '';
			});
			inputs[i].addEventListener('change', function() {
				console.log("changed " + this.id);
				control = this;
				var optionFound = false;
				datalist = control.list;

				// Determine whether an option exists with the current value of the input.
				for (var j = 0; j < datalist.options.length; j++) {
					if (control.value == datalist.options[j].value) {
						optionFound = true;
						break;
					}
				}
				// use the setCustomValidity function of the Validation API
				// to provide an user feedback if the value does not exist in the datalist
				if (optionFound) {
					control.setCustomValidity('');
				} else {
					this.value = datalist.options[0].value;
				}
			});
		}

		  document.getElementById("link_personen").className += " active";


		  var pollInterval;

		 $('#sample_form').on('submit', function(event){
		   event.preventDefault();
			$.ajax({
		   url:"/zoek_regio",
		   method:"POST",
		   data:$(this).serialize(),
		   beforeSend:function()
		   {
			resultstable = document.getElementById("results").innerHTML = "";
			$('#save').attr('disabled', 'disabled');
			$('#process').css('display', 'block');
			document.getElementById("submit").disabled = true;
		   },
		   success:function(data)
		   {
				console.log("ready");
				console.log("data : " + data);
				pollInterval = setInterval(get_progress, 1000);
				workerid = data;
				toon_kaart();
		   }
		  })
		  });

		  function get_progress() {
			console.log("checking progress for worker id "+ workerid)
			  $.ajax({
		   url:"/get_progress?workerid="+workerid,
		   method:"GET",
		   beforeSend:function()
		   {
			$('#save').attr('disabled', 'disabled');
			$('#process').css('display', 'block');
		   },
		   success:function(data)
		   {
			  datalist = JSON.parse(data);
			  completion = datalist['progress']
			  results = datalist['results']
			  urls = datalist['urls']
			  console.log("get_progress for workerid " + workerid + "="+ completion)
			  resultstable = document.getElementById("results")
			  resultstable.innerHTML = "";
			  console.log(resultstable)
			  for (var i = 0; i < results.length; i++) {
				console.log(results[i]);
				console.log(urls[i]);
				var row = resultstable.insertRow(i);
				row.insertCell().innerHTML = results[i]
				var action = "window.open('"+ urls[i]+"')"
				row.setAttribute("onclick", action)
			  }

			  progress_bar_process(parseInt(completion));
			  if (parseInt(completion) == -1) {
				toon_kaart();
				console.log("search complete");
				document.getElementById("submit").disabled = false
			  }
		   }
		  })
		  };



		  function progress_bar_process(percentage)
		  {
			$('.progress-bar').css('width', percentage + '%');
			if(percentage == -1)
			{
			  $('#process').css('display', 'none');
			  $('.progress-bar').css('width', '0%');
			  $('#save').attr('disabled', false);
			  console.log("clear")
			  clearInterval(pollInterval);
			}
		  }

		 });

		   function update_range()
		  {
		  document.getElementById("range_km").value = document.getElementById("range_slider").value + " km";
		  };

			function openTab(evt, tabName) {
			  console.log(tabName);
			  var i, tabcontent, tablinks;
			  tabcontent = document.getElementsByClassName("tab_content");
			  for (i = 0; i < tabcontent.length; i++) {
				tabcontent[i].style.display = "none";
			  }
			  tablinks = document.getElementsByClassName("tab_links");
			  for (i = 0; i < tablinks.length; i++) {
				tablinks[i].className = tablinks[i].className.replace(" active", "");
			  }
			  document.getElementById(tabName).style.display = "block";
			  evt.currentTarget.className += " active";
			}

		</script>


    </head>
    <body>

	<div class="tab">
	  <button class="tab_links shadow" id="link_personen" onclick="openTab(event, 'tab_personen')">Personen</button>
		<!--
	  <button class="tab_links shadow" onclick="openTab(event, 'tab_archieven')">Archieven</button>
	  <button class="tab_links shadow" onclick="openTab(event, 'tab_links')">Links</button>
	  <button class="tab_links shadow" onclick="openTab(event, 'tab_help')">Help</button>
	  -->

	</div>

	<div id="tab_personen" class="tab_content">
			<form action="{{ url_for('zoek_regio') }}" method="post" id="sample_form">
						<div class="personen">
							<datalist id="rollen">
							{% for id, rol in rollen %}
							<option value='{{rol}}'>{{rol}}</option>
							{% endfor %}
							</datalist>
							<fieldset class="fieldset pers1">
	  							<legend class="legend">Persoon 1</legend>
								<table >
									<tr><td><label>Naam </label></td><td><input name="pers1_achternaam"  size=30></input></td></tr>
									<tr><td><label>Voornaam </label></td><td><input name="pers1_voornaam"  size=30></input></td></tr>
									<tr>
										<td><label>Rol </label></td>
										<td>
											<input list="rollen" name="pers1_rol" id="pers1_rol"/>
										</td>
									</tr>
									<tr><td><label>Beroep </label></td><td><input name="pers1_beroep"  size=30></input></td></tr>
									<tr>
										<td><label>Geslacht </label></td>
										<td>
											<input type="checkbox" name="zw_m" id="zw_m" value="1" >M </input>
											<input type="checkbox" name="zw_v" id="zw_v" value="1" >V </input>
											<input type="checkbox" name="zw_o" id="zw_o" value="1">Niet vermeld</input>
										</td>
									</tr>
									<tr>
										<td><label>Zoekwijze </label></td>
										<td>
											<input type="radio" name="matchtype" id="mt_exact" value="Exact" checked="checked">Exact </input>
											<input type="radio" name="matchtype" id="mt_klinkt" value="Klinkt" >Klinkt als </input>
										</td>
									</tr>
								</table>
							</fieldset>

							<fieldset class="fieldset pers2">
	  							<legend class="legend">Persoon 2</legend>
								<table>
									<tr><td><label>Naam </label></td><td><input name="pers2_achternaam" size=30></input></td></tr>
									<tr><td><label>Voornaam </label></td><td><input name="pers2_voornaam" size=30></input></td></tr>
									<tr>
										<td><label>Rol </label></td>
										<td>
											<input list="rollen" name="pers2_rol" id="pers2_rol"/>
										</td>
									</tr>
								</table>
							</fieldset>
							</div>


							<fieldset class="fieldset zoekregio">
	  							<legend class="legend">Zoekregio</legend>
									<table>
									<tr>
										<td><label>Aktegemeente </label></td>
										<td>
											<input list="aktegemeentes" name="aktegemeente" id="aktegemeente"/>
											<datalist id="aktegemeentes">
											{% for gemeente in gemeentes %}
											<option value='{{gemeente}}'>{{gemeente}}</option>
											{% endfor %}
											</datalist>
										</td>
										<td></td>
									</tr>
									<tr>
										<td><label>Radius</label></td>
										<td>
										<div class="range">
										 <output id="range_km">10 km</output> <input name="radius" style="width:100%;" id="range_slider" type="range" min="0" max="50" value="10" oninput="update_range()"></input>
										</div>
										</td>
									</tr>
									<tr>
										<td></td>
									</tr>
									<tr>
										<td><label>Periode</label></td>
										<td>
										<input  name="akteperiode" id="periode"></input>
										</td>
									</tr>


									<tr><td><br></td></tr>
									<tr>
										<td><input id="submit" type="submit" name="zoek_regio" value="Zoek in omtrek"></input></td>
									</tr>

									</table>
								    <div class="progresscontainer">
									  <div class="progress-bar progress-bar-striped active bg-success" role="progressbar" aria-valuemin="0" aria-valuemax="100">
									</div>
								</div>
							</fieldset>

			</form>

							<fieldset class="fieldset resultscontainer">
	  							<legend class="legend">Resultaten</legend>

								<table id="results" class="resultstable">
								{% for gemeente,url in resultaten %}
								<tr onclick="window.open('{{url}}')";><td><A href="{{url}}"> {{gemeente}}</a></td></tr>
								{% endfor %}
								</table>
							</fieldset>

							<fieldset class="fieldset" id="fskaart">
							<legend class="legend">Kaart</legend>
								<div id="kaart" ></div>
							</fieldset>

	</div>
	<!--
	<div id="tab_archieven" class="tab_content shadow">
	</div>

	<div id="tab_help" class="tab_content shadow">
	</div>

	<div id="tab_links" class="tab_content shadow">
	</div>
	-->
    </body>
</html>
